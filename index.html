<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ù–æ–≤–æ–≥–æ–¥–Ω–∏–π –†–æ–∑—ã–≥—Ä—ã—à –°–∫–∏–¥–æ–∫</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script> 
    <style>
        /* --- –°—Ç–∏–ª–∏ –¥–ª—è TMA --- */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            color: #fff; 
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            
            background: linear-gradient(180deg, #191970 0%, #4B0082 70%, #8B0000 100%); 
            background-image: radial-gradient(white, rgba(255,255,255,.2) 2px, transparent 40px), 
                              radial-gradient(white, rgba(255,255,255,.1) 1px, transparent 30px), 
                              radial-gradient(white, rgba(255,255,255,.1) 3px, transparent 60px);
            background-size: 500px 500px, 300px 300px, 600px 600px;
            animation: snow1 15s linear infinite, snow2 20s linear infinite, snow3 25s linear infinite;
        }
        @keyframes snow1 { from { background-position: 0 0, 0 0, 0 0; } to { background-position: 500px 500px, 300px 300px, 600px 600px; } }
        @keyframes snow2 { from { background-position: 0 0, 0 0, 0 0; } to { background-position: -500px -500px, -300px -300px, -600px -600px; } }
        @keyframes snow3 { from { background-position: 0 0, 0 0, 0 0; } to { background-position: 250px 250px, 150px 150px, 300px 300px; } }

        .container {
            background: #ffffff; 
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            max-width: 400px;
            width: 100%;
            text-align: center;
            color: #333; 
        }
        h1 { color: #C0392B; margin-bottom: 10px; }
        p.instruction { color: #6c757d; margin-bottom: 30px; }

        /* –°–ö–†–ï–¢–ß-–ö–ê–†–¢–ê */
        #scratch-card-container {
            width: 300px;
            height: 150px;
            margin: 0 auto 30px;
            background-color: #eee;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            position: relative;
            overflow: hidden; 
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.8em;
            font-weight: bold;
            color: #008000; 
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }

        #scratch-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #8B0000; 
            border-radius: 10px;
            background-image: radial-gradient(circle at center, #E67E22 10%, #C0392B 100%);
            background-size: 100% 100%; 
            cursor: pointer;
            opacity: 1; 
            transition: opacity 0.1s linear; 
        }
        #scratch-layer.scratched-all {
            opacity: 0 !important;
            cursor: default;
            transition: opacity 0.5s ease-out;
        }

        .result-area { 
            display: none; 
            margin-top: 25px; 
            padding: 20px; 
            border: 2px solid #008000; 
            background-color: #e6ffe6; 
            color: #155724; 
            border-radius: 10px; 
            text-align: center; 
        }
        .result-area p { 
            font-size: 1.1em; 
            font-weight: bold; 
            color: #000; 
            margin-top: 10px;
        }

        /* --- –°–¢–ò–õ–ò –î–õ–Ø –ë–õ–û–ö–ê –ü–†–û–í–ï–†–ö–ò –ü–û–î–ü–ò–°–ö–ò --- */
        #subscription-check {
            margin-bottom: 30px;
            padding: 15px;
            background-color: #f0f0f0;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .action-button {
            display: inline-block;
            background-color: #007bff; 
            color: white;
            padding: 12px 25px;
            text-decoration: none;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
            border: none;
            transition: background-color 0.3s;
        }
        .action-button:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>üéâ –ù–æ–≤–æ–≥–æ–¥–Ω–∏–π –†–æ–∑—ã–≥—Ä—ã—à –°–∫–∏–¥–æ–∫!</h1>
    <p class="instruction" id="instruction-text">
        –ß—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —Å—Ç–µ—Ä–µ—Ç—å –±–∏–ª–µ—Ç, —Å–Ω–∞—á–∞–ª–∞ –ø–æ–¥–ø–∏—à–∏—Ç–µ—Å—å –Ω–∞ –Ω–∞—à –∫–∞–Ω–∞–ª.
    </p>

    <div id="subscription-check">
        <p style="color: #333; margin-bottom: 15px;">
            –î–ª—è —É—á–∞—Å—Ç–∏—è –ø–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ –∫–∞–Ω–∞–ª **t.me/tokk1oTT** –∏ –ø–æ–¥–ø–∏—à–∏—Ç–µ—Å—å.
        </p>
        <button id="open-channel-btn" class="action-button">
            –û—Ç–∫—Ä—ã—Ç—å –∫–∞–Ω–∞–ª tokk1oTT
        </button>
    </div>
    
    <div id="scratch-card-container" style="display: none;"> 
        <span id="prize-text"></span> 
        <div id="scratch-layer"></div>
    </div>
    
    <div id="result-area" class="result-area">
    </div>
</div>

<script>
    const CHANNEL_URL = 'https://t.me/tokk1oTT';
    const LOCAL_STORAGE_KEY = 'tokk1o_scratch_game_played'; // –ö–ª—é—á –¥–ª—è LocalStorage
    
    // --- –≠–ª–µ–º–µ–Ω—Ç—ã DOM ---
    const SUBSCRIPTION_CHECK = document.getElementById('subscription-check');
    const OPEN_CHANNEL_BTN = document.getElementById('open-channel-btn');
    const SCRATCH_CARD_CONTAINER = document.getElementById('scratch-card-container');

    const SCRATCH_LAYER = document.getElementById('scratch-layer');
    const PRIZE_TEXT_ELEM = document.getElementById('prize-text');
    const RESULT_AREA = document.getElementById('result-area');
    const INSTRUCTION = document.getElementById('instruction-text');

    // --- –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –∏–≥—Ä—ã ---
    const PRIZE_WEIGHTS = [
        { prize: "–°–∫–∏–¥–∫–∞ 30%", weight: 1000 }, 
        { prize: "–°–∫–∏–¥–∫–∞ 20%", weight: 2500 }, 
        { prize: "–°–∫–∏–¥–∫–∞ 15%", weight: 3000 }, 
        { prize: "–°–∫–∏–¥–∫–∞ 10%", weight: 3500 }
    ];
    const TOTAL_WEIGHT = 10000;
    const TIMER_DELAY = 4000; // 4 —Å–µ–∫—É–Ω–¥—ã

    // --- –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è ---
    let hasPlayed = false; // –°–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã
    let isScratching = false;
    let finalPrize = "";
    let timerStarted = false; 
    let opacityValue = 1.0; 
    const OPACITY_DECREASE = 0.05; 
    
    // --- 1. –§—É–Ω–∫—Ü–∏–∏ LocalStorage ---
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –∏–≥—Ä–∞–ª –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ (–Ω–∞ —ç—Ç–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ)
    function checkIfPlayed() {
        const storedData = localStorage.getItem(LOCAL_STORAGE_KEY);
        if (storedData) {
            hasPlayed = true;
            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π –ø—Ä–∏–∑
            return JSON.parse(storedData).prize; 
        }
        return null;
    }

    // –°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∏–≥—Ä—ã
    function setPlayedState(prize) {
        localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify({ prize: prize, timestamp: Date.now() }));
    }

    // --- 2. –§—É–Ω–∫—Ü–∏–∏ TMA –∏ –ø–æ–¥–ø–∏—Å–∫–∏ ---
    
    function openChannel() {
        if (window.Telegram && window.Telegram.WebApp) {
            window.Telegram.WebApp.openLink(CHANNEL_URL); 
            
            // –ú–µ–Ω—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ —à–∞–≥–∞
            INSTRUCTION.textContent = '–ü–æ–¥–ø–∏—à–∏—Ç–µ—Å—å –∏ –≤–µ—Ä–Ω–∏—Ç–µ—Å—å. –ù–∞–∂–º–∏—Ç–µ "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å", —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –ø—Ä–∏–∑.';
            OPEN_CHANNEL_BTN.textContent = '–Ø –ø–æ–¥–ø–∏—Å–∞–ª—Å—è/–ª–∞—Å—å (–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å)';
            
            // –ú–µ–Ω—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞ —Ñ—É–Ω–∫—Ü–∏—é –∞–∫—Ç–∏–≤–∞—Ü–∏–∏
            OPEN_CHANNEL_BTN.removeEventListener('click', openChannel);
            OPEN_CHANNEL_BTN.addEventListener('click', activateScratchCard);

        } else {
            // –†–µ–∂–∏–º —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ
            window.open(CHANNEL_URL, '_blank');
            activateScratchCard();
        }
    }

    function activateScratchCard() {
        SUBSCRIPTION_CHECK.style.display = 'none';
        SCRATCH_CARD_CONTAINER.style.display = 'flex';
        INSTRUCTION.textContent = '–°–æ—Ç—Ä–∏—Ç–µ –∑–∞—â–∏—Ç–Ω—ã–π —Å–ª–æ–π, —á—Ç–æ–±—ã —É–∑–Ω–∞—Ç—å, –∫–∞–∫—É—é —Å–∫–∏–¥–∫—É –≤—ã –≤—ã–∏–≥—Ä–∞–ª–∏!';
        initializeGameLogic();
    }

    // --- 3. –õ–æ–≥–∏–∫–∞ –∏–≥—Ä—ã (—Ñ—É–Ω–∫—Ü–∏–∏ —Å—Ç–∏—Ä–∞–Ω–∏—è –∏ —Ä–∞–Ω–¥–æ–º–∞) ---
    
    function getWeightedRandomPrize() {
        const randomValue = Math.floor(Math.random() * TOTAL_WEIGHT) + 1;
        let currentSum = 0;
        for (const item of PRIZE_WEIGHTS) {
            currentSum += item.weight;
            if (randomValue <= currentSum) {
                return item.prize;
            }
        }
        return PRIZE_WEIGHTS[PRIZE_WEIGHTS.length - 1].prize;
    }

    function startScratching(e) {
        e.preventDefault(); 
        if (SCRATCH_LAYER.classList.contains('scratched-all')) return;

        isScratching = true;

        if (!timerStarted) {
            timerStarted = true;
            
            setTimeout(() => {
                if (!SCRATCH_LAYER.classList.contains('scratched-all')) {
                    revealPrize();
                }
            }, TIMER_DELAY); 
        }
        scratch(e); 
    }

    function stopScratching() {
        isScratching = false;
    }

    function scratch(e) {
        if (!isScratching || SCRATCH_LAYER.classList.contains('scratched-all')) return;

        opacityValue = Math.max(0, opacityValue - OPACITY_DECREASE);
        SCRATCH_LAYER.style.opacity = opacityValue;
        
        if (opacityValue < 0.2) { 
            revealPrize();
        }
    }

    function revealPrize() {
        SCRATCH_LAYER.classList.add('scratched-all'); 
        
        // –£–¥–∞–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        SCRATCH_LAYER.removeEventListener('mousedown', startScratching);
        SCRATCH_LAYER.removeEventListener('mousemove', scratch);
        SCRATCH_LAYER.removeEventListener('mouseup', stopScratching);
        SCRATCH_LAYER.removeEventListener('touchstart', startScratching);
        SCRATCH_LAYER.removeEventListener('touchmove', scratch);
        SCRATCH_LAYER.removeEventListener('touchend', stopScratching);

        setPlayedState(finalPrize); // <--- –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        displayResult(finalPrize);
    }

    function displayResult(prize, isReplay = false) {
        const headerText = isReplay ? `–í–∞—à –ø—Ä–∏–∑: ${prize} (–ü–æ–≤—Ç–æ—Ä–Ω—ã–π –ø–æ–∫–∞–∑)` : `üéÅ –í–∞—à –ø—Ä–∏–∑: ${prize}!`;
        const instructionText = '–°–¥–µ–ª–∞–π—Ç–µ —Å–∫—Ä–∏–Ω —Å–∫–∏–¥–∫–∏ –∏ –ø–æ–∫–∞–∂–∏—Ç–µ –ø—Ä–æ–¥–∞–≤—Ü—É.';

        RESULT_AREA.innerHTML = `
            <h2>${headerText}</h2>
            <p>${instructionText}</p>
        `;
        RESULT_AREA.style.display = 'block';
        INSTRUCTION.textContent = isReplay ? '–í—ã —É–∂–µ —Å—ã–≥—Ä–∞–ª–∏. –í–æ—Ç –≤–∞—à –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç.' : '–°–ø–∞—Å–∏–±–æ –∑–∞ –∏–≥—Ä—É! –í–∞—à–∞ –ø–æ–ø—ã—Ç–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∞.';
    }

    function initializeGameLogic() {
        finalPrize = getWeightedRandomPrize();
        PRIZE_TEXT_ELEM.textContent = finalPrize.toUpperCase();

        SCRATCH_LAYER.addEventListener('mousedown', startScratching);
        SCRATCH_LAYER.addEventListener('mousemove', scratch);
        SCRATCH_LAYER.addEventListener('mouseup', stopScratching);
        SCRATCH_LAYER.addEventListener('touchstart', startScratching);
        SCRATCH_LAYER.addEventListener('touchmove', scratch);
        SCRATCH_LAYER.addEventListener('touchend', stopScratching);
        
        document.addEventListener('mouseup', stopScratching);
        document.addEventListener('touchend', stopScratching);
    }

    // --- 4. –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ---
    window.onload = function() {
        if (window.Telegram && window.Telegram.WebApp) {
             window.Telegram.WebApp.ready();
        }
        
        const previousPrize = checkIfPlayed();
        
        if (previousPrize) {
            // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –∏–≥—Ä–∞–ª, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            SUBSCRIPTION_CHECK.style.display = 'none';
            SCRATCH_CARD_CONTAINER.style.display = 'none'; // –°–∫—Ä—ã–≤–∞–µ–º –±–∏–ª–µ—Ç, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –∏—Å–∫—É—à–µ–Ω–∏—è —Å—Ç–∏—Ä–∞—Ç—å
            displayResult(previousPrize, true);
        } else {
            // –ù–∞—á–∏–Ω–∞–µ–º —Å –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–ø–∏—Å–∫–∏
            OPEN_CHANNEL_BTN.addEventListener('click', openChannel);
        }
    };
</script>

</body>
</html>
